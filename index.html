<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de PDF por CPF - FGV</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: oklch(0.45 0.15 250);
            --success-color: oklch(0.55 0.15 140);
            --danger-color: oklch(0.55 0.15 20);
            --warning-color: oklch(0.75 0.15 80);
            --text-color: oklch(0.2 0.01 250);
            --bg-color: oklch(0.98 0.01 250);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }
        
        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            background: white;
        }
        
        .card-header {
            border-radius: 1rem 1rem 0 0 !important;
            padding: 2rem;
        }
        
        .form-control {
            border-radius: 0.5rem;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .form-control.is-invalid {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
            transition: all 0.3s ease;
        }
        
        .form-control.is-valid {
            border-color: var(--success-color);
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
            transition: all 0.3s ease;
        }
        
        .form-control.is-invalid,
        .form-control.is-valid {
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .text-danger {
            color: var(--danger-color) !important;
        }
        
        .text-success {
            color: var(--success-color) !important;
        }
        
        
        .btn-success {
            background: var(--success-color);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 2rem;
            font-weight: 600;
        }
        
        .alert {
            border-radius: 0.5rem;
            border: none;
        }
        
        .alert-success {
            background-color: oklch(0.9 0.05 140);
            color: var(--success-color);
        }
        
        .alert-danger {
            background-color: oklch(0.9 0.05 20);
            color: var(--danger-color);
        }
        
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        .loading-text {
            margin-left: 0.5rem;
        }
        
        
        .hidden {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .logo-container img {
            max-width: 300px;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12">
                    <div class="logo-container">
                        <img src="logo-fgv-conhecimento.svg" alt="FGV Conhecimento" />
                    </div>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="card">
                        <div class="card-header text-center bg-white">
                            <h2 class="mb-0 fw-bold text-dark">
                                Consulta de Documentos
                            </h2>
                            <p class="mb-0 mt-2 opacity-75">Digite seu CPF para consultar seu documento</p>
                        </div>
                        <div class="card-body p-4">
                            <!-- Formulário de consulta -->
                            <div id="searchForm">
                                <div class="mb-4">
                                    <label for="cpfInput" class="form-label fw-bold">CPF</label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="cpfInput" 
                                        placeholder="000.000.000-00"
                                        maxlength="14"
                                        autocomplete="off"
                                    >
                                    <div class="form-text">Digite apenas os números.</div>
                                    <div id="cpfFeedback" class="form-text mt-2 hidden"></div>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" id="searchBtn" disabled>
                                        <i class="fas fa-search me-2"></i>
                                        Pesquisar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Loading -->
                            <div id="loadingDiv" class="hidden text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-3 mb-0 loading-text">Consultando documento...</p>
                            </div>
                            
                            <!-- Resultado positivo -->
                            <div id="successDiv" class="hidden">
                                <div class="alert alert-success fade-in">
                                    <h5 class="alert-heading">
                                        <i class="fas fa-check-circle me-2"></i>
                                        Documento encontrado!
                                    </h5>
                                    <p class="mb-3">O PDF foi localizado com sucesso para o CPF informado. Abrindo automaticamente...</p>
                                    <hr>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-success" id="openPdfBtn">
                                            <i class="fas fa-external-link-alt me-2"></i>
                                            Abrir PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resultado negativo -->
                            <div id="errorDiv" class="hidden">
                                <div class="alert alert-danger fade-in">
                                    <h5 class="alert-heading">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Documento não encontrado
                                    </h5>
                                    <p class="mb-0">PDF não encontrado para este CPF. Verifique se o número está correto ou entre em contato com o suporte.</p>
                                </div>
                                <div class="d-grid mt-3">
                                    <button type="button" class="btn btn-outline-primary" id="newSearchBtn">
                                        <i class="fas fa-search me-2"></i>
                                        Nova Consulta
                                    </button>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ngx-extended-pdf-viewer -->
    <script src="https://cdn.jsdelivr.net/npm/ngx-extended-pdf-viewer@latest/assets/pdf.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ngx-extended-pdf-viewer@latest/assets/pdf.worker.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        class CPFValidator {
            constructor() {
                this.searchBtn = document.getElementById('searchBtn');
                this.cpfInput = document.getElementById('cpfInput');
                this.loadingDiv = document.getElementById('loadingDiv');
                this.successDiv = document.getElementById('successDiv');
                this.errorDiv = document.getElementById('errorDiv');
                this.searchForm = document.getElementById('searchForm');
                this.openPdfBtn = document.getElementById('openPdfBtn');
                this.newSearchBtn = document.getElementById('newSearchBtn');
                
                this.currentCpf = '';
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.applyCPFMask();
                // Inicializa o botão como desabilitado
                this.searchBtn.disabled = true;
            }
            
            setupEventListeners() {
                this.searchBtn.addEventListener('click', () => this.handleSearch());
                this.openPdfBtn.addEventListener('click', () => this.openPdf());
                this.newSearchBtn.addEventListener('click', () => this.resetForm());
                
                // Removido - a validação agora é chamada dentro de applyCPFMask()
                this.cpfInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleSearch();
                    }
                });
            }
            
            applyCPFMask() {
                this.cpfInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length <= 11) {
                        // Aplica a máscara
                        if (value.length >= 4) {
                            value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        }
                        if (value.length >= 7) {
                            value = value.replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
                        }
                        if (value.length >= 10) {
                            value = value.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3-$4');
                        }
                        
                        e.target.value = value;
                        
                        // Chama a validação com os números puros
                        this.validateCPF(value.replace(/\D/g, ''));
                    }
                });
            }
            
            validateCPF(cpfNumbers) {
                const feedbackDiv = document.getElementById('cpfFeedback');
                
                // Primeiro verifica se tem 11 dígitos
                if (cpfNumbers.length !== 11) {
                    this.searchBtn.disabled = true;
                    this.clearFeedback();
                    return;
                }
                
                // Depois verifica se é um CPF válido
                const isValid = this.isValidCPF(cpfNumbers);
                this.searchBtn.disabled = !isValid;
                
                if (!isValid) {
                    this.showInvalidFeedback();
                } else {
                    this.clearFeedback();
                }
            }
            
            clearFeedback() {
                const input = this.cpfInput;
                const feedbackDiv = document.getElementById('cpfFeedback');
                
                input.classList.remove('is-valid', 'is-invalid');
                feedbackDiv.classList.add('hidden');
                feedbackDiv.textContent = '';
            }
            
            
            showInvalidFeedback() {
                const input = this.cpfInput;
                const feedbackDiv = document.getElementById('cpfFeedback');
                
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                
                feedbackDiv.classList.remove('hidden', 'text-success');
                feedbackDiv.classList.add('text-danger');
                feedbackDiv.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>CPF inválido';
            }
            
            isValidCPF(cpf) {
                if (cpf.length !== 11) return false;
                
                // Verifica se todos os dígitos são iguais
                if (/^(\d)\1{10}$/.test(cpf)) return false;
                
                // Validação do CPF
                let sum = 0;
                for (let i = 0; i < 9; i++) {
                    sum += parseInt(cpf.charAt(i)) * (10 - i);
                }
                let remainder = (sum * 10) % 11;
                if (remainder === 10 || remainder === 11) remainder = 0;
                if (remainder !== parseInt(cpf.charAt(9))) return false;
                
                sum = 0;
                for (let i = 0; i < 10; i++) {
                    sum += parseInt(cpf.charAt(i)) * (11 - i);
                }
                remainder = (sum * 10) % 11;
                if (remainder === 10 || remainder === 11) remainder = 0;
                if (remainder !== parseInt(cpf.charAt(10))) return false;
                
                return true;
            }
            
            async handleSearch() {
                const cpf = this.cpfInput.value.replace(/\D/g, '');
                
                if (!this.isValidCPF(cpf)) {
                    alert('Por favor, digite um CPF válido.');
                    return;
                }
                
                this.showLoading();
                
                try {
                    // Simula consulta ao backend
                    const pdfExists = await this.checkPdfExists(cpf);
                    
                    setTimeout(() => {
                        if (pdfExists) {
                            this.showSuccess();
                        } else {
                            this.showError();
                        }
                    }, 2000); // Simula delay de rede
                    
                } catch (error) {
                    setTimeout(() => {
                        this.showError();
                    }, 2000);
                }
            }
            
            async checkPdfExists(cpf) {
                // Simula consulta ao bucket /files/{CPF}.pdf
                // Por enquanto, retorna true para CPFs que terminam em número par (simulação)
                return parseInt(cpf.slice(-1)) % 2 === 0;
            }
            
            showLoading() {
                this.hideAllResults();
                this.searchForm.classList.add('hidden');
                this.loadingDiv.classList.remove('hidden');
            }
            
            showSuccess() {
                this.hideAllResults();
                this.successDiv.classList.remove('hidden');
                
                // Abre o PDF automaticamente após um pequeno delay
                setTimeout(() => {
                    this.openPdf();
                }, 1000); // 1 segundo de delay para o usuário ver a mensagem de sucesso
            }
            
            showError() {
                this.hideAllResults();
                this.errorDiv.classList.remove('hidden');
            }
            
            hideAllResults() {
                this.loadingDiv.classList.add('hidden');
                this.successDiv.classList.add('hidden');
                this.errorDiv.classList.add('hidden');
                this.searchForm.classList.add('hidden');
            }
            
            openPdf() {
                const cpf = this.cpfInput.value.replace(/\D/g, '');
                const pdfUrl = `/files/${cpf}.pdf`;
                
                // Abre PDF na mesma aba
                window.location.href = pdfUrl;
            }
            
            
            resetForm() {
                this.cpfInput.value = '';
                this.currentCpf = '';
                this.searchBtn.disabled = true;
                this.hideAllResults();
                this.searchForm.classList.remove('hidden');
                this.clearFeedback();
                this.cpfInput.focus();
            }
        }
        
        // Inicializa a aplicação quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', () => {
            new CPFValidator();
        });
    </script>
</body>
</html>
